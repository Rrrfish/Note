# B+树的节点

`InnoDB`的磁盘读取单位是数据页，默认数据页大小位16`KB`。

**`B+`树的每一个节点也是一个数据页。**

## 数据页结构

数据页结构如下
```
---------------------------------
|    File Header 38Byte         |
---------------------------------
|    Page Header 56Byte         |
---------------------------------
|    Infimum + Supremum 26Byte  |
---------------------------------
|    User Record Uncertain      |
---------------------------------
|    Free Space Uncertain       |
---------------------------------
|    Page Directory Uncertain   |
---------------------------------
|    File Trailer 8Byte         |
---------------------------------
```

**User Record（用户记录）**：用来存储行记录内容.

**Page Directory**：存储用户记录的相对位置，对记录起到索引的作用。



#### 数据页外部的连接

File Header 中有两个指针，分别指向上一个数据页和下一个数据页，连接起来的页相当于一个**双向链表**。

#### 数据页内部的连接

数据页中的记录按照「主键」顺序组成**单向链表**。



### 创建页目录的过程

1. 将所有记录进行分组，包括最小记录和最大记录，但是不包括已删除的记录。
2. 每个记录组的最后一条记录是组内最大记录，并且最大记录会标记本组共有多少条记录，作为`n_word`字段。
3. 页目录存储着一个个“**槽**”，它存储着每一组记录的最后一条记录的地址偏移量。

**槽相当于记录的索引**。



### 查找记录的过程

利用二分法进行记录查找。例如查找主键为7的用户记录。

一共有0、1、2、3、4五个分组。通过二分法发现记录位于第3组中，7大于第2组最大记录6，小于第3组最大记录10。

又由于数据页内部的记录由单向链表串联，所以需要从第二组最大记录开始遍历，找到目标记录。

为了避免组内记录太多，时间复杂度退化，`InnoDB` 对每个分组中的记录条数都有规定：

- 第一个分组中的记录只能有 1 条记录；
- 最后一个分组中的记录条数范围只能在 1-8 条之间；
- 剩下的分组中记录条数范围只能在 4-8 条之间；



## `B+`树的查询过程

`B+`树的每一个节点就是一个数据页。`B+`树搜索目标节点的方法和正常的树的搜索差不多。



## 聚簇索引和二级索引

`InnoDB` 在创建聚簇索引时，有三种情况：

- 如果有主键，默认会使用主键作为聚簇索引的索引键；
- 如果没有主键，就选择第一个不包含 NULL 值的唯一列作为聚簇索引的索引键；
- 在上面两个都没有的情况下，`InnoDB` 将自动生成一个隐式自增 id 列作为聚簇索引的索引键；

**数据在物理上只会保存一份，所以聚簇索引也只有一个**。





# 为什么`MySQL`采用`B+`树作为索引的实现

## B+ 和 B 树的性能区别

### 1、单点查询

B 树进行单个索引查询时，最快可以在 O(1) 的时间代价内就查到，而从平均时间代价来看，会比 B+ 树稍快一些。

但是 B 树的查询波动会比较大，因为每个节点即存索引又存记录，所以有时候访问到了非叶子节点就可以找到索引，而有时需要访问到叶子节点才能找到索引。

**B+ 树的非叶子节点不存放实际的记录数据，仅存放索引，因此数据量相同的情况下，相比存储即存索引又存记录的 B 树，B+树的非叶子节点可以存放更多的索引，因此 B+ 树可以比 B 树更「矮胖」，查询底层节点的磁盘 I/O次数会更少**。

### 2、插入和删除效率

`B+`树删除节点非常快，可以从叶子结点直接删除，很多时候都不需要动叶节点。树形结构变化很小。

B+ 树的插入也是一样，有冗余节点，插入可能存在节点的分裂（如果节点饱和），但是最多只涉及树的一条路径。而且 B+ 树会自动平衡。

**B+ 树的插入和删除效率更高**。

### 3、范围查询

B+ 树所有叶子节点间还有一个链表进行连接，适合进行范围查询

存在大量范围检索的场景，适合使用 B+树，比如数据库。而对于大量的单个索引查询的场景，可以考虑 B 树，比如 `nosql` 的`MongoDB`。



`InnoDB` 使用的 `B+` 树有一些特别的点，比如：

- B+ 树的叶子节点之间是用「双向链表」进行连接，这样的好处是既能向右遍历，也能向左遍历。
- B+ 树点节点内容是数据页，数据页里存放了用户的记录以及各种信息，每个数据页默认大小是 16 KB。















