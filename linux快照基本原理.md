# `linux`快照基本原理

## 快照和备份的区别

### 技术实现差异

**快照**：通常依赖于文件系统或存储系统的功能。例如，在很多现代文件系统中（如`ZFS`或`Btrfs`），快照是通过在数据块层面记录变化来实现的。这种方法不需要复制每一个数据块，而是仅保存那些自快照创建后发生变更的块。因此，创建快照非常快速，几乎不影响系统性能。

**备份**：可能是通过软件在操作系统层面进行的，它会复制所有选定的文件和配置到另一个位置。这个过程可能涉及大量的数据传输，因此更耗时，对系统性能的影响也更大。

### 数据一致性差异

**快照**：快照可以捕获特定时间点的数据状态，包括正在进行的事务和活动，因此可能不是一个一致的数据副本。

**备份**：备份通常会等待活动的完成或使用一致性技术，以确保复制的数据是一个一致的、完整的副本。

### 使用目的的差异

**快照**：快照通常用于分析、查询历史数据、测试和开发环境的创建，以及应用程序的版本管理。比如数据库的事务处理或虚拟机状态的保存。快照允许用户在出现问题时快速回滚到之前的状态。

**备份**：特别适合处理文件损坏、系统崩溃或灾难性事件。

### 存储大小差异

**快照**：占用空间小。

**备份**：占用空间大。

### 恢复能力差异

**快照**提供了快速的数据恢复能力，因为它们通常与原始数据保持一定的关联，并且存储在同一存储系统中。这使得从快照中恢复数据既快速又容易，特别是在恢复小量数据时。

而**备份**则更适合全面的灾难恢复场景。备份文件通常存储在系统外部，这为恢复提供了物理隔离，确保在原始系统彻底损坏的情况下还能恢复数据。不过，从备份恢复数据通常比从快照恢复更慢，尤其是当数据量很大时。



## `COW`和`ROW`

![image-20240615153803073](/home/rui/.config/Typora/typora-user-images/image-20240615153803073.png)

### `COW`（Copy-on-Write）写时复制

写时复制快照使用预先分配的快照空间进行快照创建，在快照时间点之后，没有物理数据复制发生，仅仅复制了原始数据物理位置的元数据。因此，快照创建非常 快，可以瞬间完成。然后，快照副本跟踪原始卷的数据变化（即原始卷写操作），一旦原始卷数据块发生**首次更新**，则先将原始卷数据块读出并写入快照卷，然后用 新数据块覆盖原始卷。下一次的写入则不会再执行写时复制动作，实现了保存原始数据的效果。

如果更新的数据数量超过保留空间，快照就将失效。

### `ROW`（Redirect-on-Write）写时重定向

ROW在写入数据的时候直接写入到快照卷；读源卷时，创建快照前的数据从源卷读，创建快照后产生的数据，从快照卷读。